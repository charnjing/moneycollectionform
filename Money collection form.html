<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Money Collection Form</title>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const deptSelect = document.getElementById("dept");
            const stallSelect = document.getElementById("stall");

            // Default stall options
            const defaultStalls = {
                "TPY Lor 8 Table Cleaning": Array.from({ length: 80 }, (_, i) => `#01-${String(i + 1).padStart(2, '0')}`),
                "TPY Lor 8 Dishwashing": Array.from({ length: 80 }, (_, i) => `#01-${String(i + 1).padStart(2, '0')}`),
                "TPY Lor 8 Utensils Rental": Array.from({ length: 80 }, (_, i) => `#01-${String(i + 1).padStart(2, '0')}`),
                "TPY Lor 4 Table Cleaning": Array.from({ length: 28 }, (_, i) => `#01-${String(i + 33).padStart(2, '0')}`)
            };

            // Load department options
            function loadDeptOptions() {
                const depts = Object.keys(defaultStalls);
                depts.forEach(dept => {
                    const option = document.createElement("option");
                    option.value = dept;
                    option.textContent = dept;
                    deptSelect.appendChild(option);
                });
            }

            // Load stall options based on selected department
            function loadStallOptions(dept) {
                stallSelect.innerHTML = ""; // Clear existing options
                if (defaultStalls[dept]) {
                    defaultStalls[dept].forEach(stall => {
                        const option = document.createElement("option");
                        option.value = stall;
                        option.textContent = stall;
                        stallSelect.appendChild(option);
                    });
                }
            }

            // Event listener for department change
            deptSelect.addEventListener("change", (e) => {
                loadStallOptions(e.target.value);
            });

            // Initialize options on page load
            loadDeptOptions();
            loadStallOptions(deptSelect.value);
        });

        function submitForm(event) {
            event.preventDefault();

            const formData = {
                datetime: new Date().toISOString(),
                dept: document.getElementById("dept").value,
                stall: document.getElementById("stall").value,
                payment: document.querySelector('input[name="payment"]:checked')?.value || "",
                amount: document.getElementById("amount").value,
                period: document.getElementById("period").value
            };

            // Store data offline if offline
            if (!navigator.onLine) {
                const submissions = JSON.parse(localStorage.getItem("submissions") || "[]");
                submissions.push(formData);
                localStorage.setItem("submissions", JSON.stringify(submissions));
                alert("Form submitted offline. It will sync when online.");
            } else {
                sendToGoogleSheet(formData);
            }
        }

        function sendToGoogleSheet(data) {
            fetch("https://script.google.com/macros/s/AKfycbyw9Pn6FkYlPo875JmJt3_M2a1-SO31JxGnCe-vW-UgzUoK6zjwDREjINrm06_OhzRD/exec", {
                method: "POST",
                body: JSON.stringify(data),
                headers: { "Content-Type": "application/json" },
            })
                .then(response => response.json())
                .then(result => {
                    alert("Submission sent!");
                    syncOfflineSubmissions(); // Try syncing offline submissions after successful submission
                })
                .catch(error => {
                    alert("Error submitting form: " + error.message);
                });
        }

        function syncOfflineSubmissions() {
            if (navigator.onLine) {
                const submissions = JSON.parse(localStorage.getItem("submissions") || "[]");
                if (submissions.length > 0) {
                    submissions.forEach(submission => {
                        sendToGoogleSheet(submission);
                    });
                    localStorage.removeItem("submissions");
                    alert("Offline submissions synced!");
                }
            }
        }

        window.addEventListener("online", syncOfflineSubmissions);
    </script>
</head>
<body>
    <h2>Money Collection Form</h2>
    <form onsubmit="submitForm(event)">
        <label for="dept">Dept:</label>
        <select id="dept" required></select>

        <label for="stall">Stall Number:</label>
        <select id="stall" required></select>

        <label>Payment:</label>
        <input type="radio" name="payment" value="Cash" required> Cash
        <input type="radio" name="payment" value="Cashless" required> Cashless

        <label for="amount">Amount:</label>
        <input type="number" id="amount" step="0.01" required>

        <label for="period">Period:</label>
        <select id="period" required>
            <option value="Jan 1">Jan 1</option>
            <option value="Jan 2">Jan 2</option>
            <option value="Feb 1">Feb 1</option>
            <option value="Feb 2">Feb 2</option>
            <option value="Mar 1">Mar 1</option>
            <option value="Mar 2">Mar 2</option>
            <option value="Apr 1">Apr 1</option>
            <option value="Apr 2">Apr 2</option>
            <option value="May 1">May 1</option>
            <option value="May 2">May 2</option>
            <option value="Jun 1">Jun 1</option>
            <option value="Jun 2">Jun 2</option>
            <option value="Jul 1">Jul 1</option>
            <option value="Jul 2">Jul 2</option>
            <option value="Aug 1">Aug 1</option>
            <option value="Aug 2">Aug 2</option>
            <option value="Sep 1">Sep 1</option>
            <option value="Sep 2">Sep 2</option>
            <option value="Oct 1">Oct 1</option>
            <option value="Oct 2">Oct 2</option>
            <option value="Nov 1">Nov 1</option>
            <option value="Nov 2">Nov 2</option>
            <option value="Dec 1">Dec 1</option>
            <option value="Dec 2">Dec 2</option>
        </select>

        <button type="submit">Submit</button>
    </form>
</body>
</html>
